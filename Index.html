<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IsoMetric Hair Tracker</title>

    <style>
        :root { --accent: #00ff88; --bg: #0a0a0c; }
        body {
            margin: 0;
            background: var(--bg);
            color: #fff;
            font-family: sans-serif;
            overflow: hidden;
        }

        .nav-bar {
            background: #151515;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: center;
            position: relative;
            z-index: 20;
        }

        select {
            background: #222;
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 10px;
            border-radius: 5px;
            width: 90%;
            font-weight: bold;
            font-size: 14px;
        }

        .viewer-box {
            position: relative;
            height: 55vh;
            width: 100vw;
            background: #000;
            overflow: hidden;
        }

        video, .slide-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }

        #after-wrap {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            overflow: hidden;
            z-index: 5;
            border-right: 2px solid var(--accent);
        }

        #slider-handle {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 2px;
            background: var(--accent);
            z-index: 10;
            display: none;
        }

        #ghost {
            position: absolute;
            inset: 0;
            opacity: 0.35;
            z-index: 2;
            pointer-events: none;
            mix-blend-mode: screen;
            display: none;
        }

        .tabs {
            display: flex;
            background: #111;
            position: fixed;
            bottom: 0;
            width: 100%;
            border-top: 1px solid #333;
            z-index: 30;
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            font-size: 12px;
            color: #666;
            font-weight: bold;
            text-transform: uppercase;
        }

        .tab.active {
            color: var(--accent);
            background: #1a1a1a;
            border-top: 3px solid var(--accent);
        }

        .panel {
            padding: 15px;
            height: 35vh;
            box-sizing: border-box;
            display: none;
            overflow-y: auto;
        }

        .panel.active {
            display: block;
            text-align: center;
        }

        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 18px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,255,136,0.2);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-bottom: 80px;
        }

        .gallery-item {
            background: #151515;
            border-radius: 8px;
            padding: 5px;
            border: 1px solid #222;
        }

        .gallery-item img {
            width: 100%;
            border-radius: 5px;
        }

        .gallery-item span {
            font-size: 10px;
            color: #888;
            display: block;
            margin-top: 5px;
        }

        #status {
            margin-top: 12px;
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

<div class="nav-bar">
    <select id="angleSelect" onchange="changeAngle()">
        <option value="front">VIEW: FRONT</option>
        <option value="left">VIEW: LEFT 45°</option>
        <option value="right">VIEW: RIGHT 45°</option>
    </select>
</div>

<div class="viewer-box" id="viewer">
    <video id="v" autoplay playsinline muted></video>
    <img id="ghost">
    <div id="after-wrap"><img id="after-img" class="slide-img"></div>
    <img id="before-img" class="slide-img" style="display:none; z-index:1;">
    <div id="slider-handle"></div>
</div>

<div id="scan-panel" class="panel active">
    <button id="capBtn" class="btn">CAPTURE</button>
    <div id="status">Ready</div>
    <button onclick="resetViewer()" style="background:none;border:none;color:#444;margin-top:15px;font-size:11px;text-decoration:underline;">
        RESET VIEWER
    </button>
</div>

<div id="history-panel" class="panel">
    <div class="gallery-grid" id="gallery"></div>
</div>

<div class="tabs">
    <div class="tab active" onclick="showPanel('scan', this)">SCAN & COMPARE</div>
    <div class="tab" onclick="showPanel('history', this)">GALLERY HISTORY</div>
</div>

<script>
    // Generic user namespace (can be replaced with auth later)
    const USER_ID = "default_user";

    const v = document.getElementById('v');
    const ghost = document.getElementById('ghost');
    const beforeImg = document.getElementById('before-img');
    const afterImg = document.getElementById('after-img');
    const afterWrap = document.getElementById('after-wrap');
    const handle = document.getElementById('slider-handle');
    const capBtn = document.getElementById('capBtn');
    const status = document.getElementById('status');
    const angleSelect = document.getElementById('angleSelect');

    let currentAngle = localStorage.getItem('last_angle') || 'front';
    angleSelect.value = currentAngle;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => {
            v.srcObject = stream;
            updateUI();
        });

    function changeAngle() {
        currentAngle = angleSelect.value;
        localStorage.setItem('last_angle', currentAngle);
        resetViewer();
    }

    function resetViewer() {
        v.style.display = 'block';
        afterWrap.style.display = 'none';
        beforeImg.style.display = 'none';
        handle.style.display = 'none';
        status.innerText = "Ready";
        updateUI();
    }

    function showPanel(panel, el) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(panel + '-panel').classList.add('active');
        el.classList.add('active');
        if (panel === 'history') fetchHistory();
    }

    async function fetchHistory() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "<div style='color:#555;'>Loading...</div>";
        const res = await fetch(`/history?angle=${currentAngle}&user_id=${USER_ID}`);
        const data = await res.json();

        if (!data.length) {
            gallery.innerHTML = "<div style='color:#555;grid-column:1/3;'>No scans yet.</div>";
            return;
        }

        gallery.innerHTML = data.map(img => `
            <div class="gallery-item">
                <img src="${img.data}">
                <span>${img.name}</span>
            </div>
        `).join('');
    }

    function updateUI() {
        const base = localStorage.getItem('base_' + currentAngle);
        if (base) {
            ghost.src = base;
            ghost.style.display = 'block';
            capBtn.innerText = "RUN " + currentAngle.toUpperCase() + " SCAN";
        } else {
            ghost.style.display = 'none';
            capBtn.innerText = "SET " + currentAngle.toUpperCase() + " BASELINE";
        }
    }

    capBtn.onclick = async () => {
        status.innerText = "PROCESSING...";
        const canvas = document.createElement('canvas');
        canvas.width = v.videoWidth;
        canvas.height = v.videoHeight;
        canvas.getContext('2d').drawImage(v, 0, 0);

        const dataURL = canvas.toDataURL('image/jpeg', 0.8);

        const res = await fetch('/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: dataURL,
                angle: currentAngle,
                user_id: USER_ID
            })
        });

        const data = await res.json();

        if (data.status === 'baseline_set') {
            localStorage.setItem('base_' + currentAngle, dataURL);
            status.innerText = "BASELINE LOCKED";
            updateUI();
        } else if (data.status === 'success') {
            v.style.display = 'none';
            ghost.style.display = 'none';
            beforeImg.src = localStorage.getItem('base_' + currentAngle);
            beforeImg.style.display = 'block';
            afterImg.src = data.aligned_image;
            afterWrap.style.display = 'block';
            afterWrap.style.width = '50%';
            handle.style.display = 'block';
            handle.style.left = '50%';
            status.innerText = "COMPARISON READY";
        } else {
            status.innerText = data.message;
        }
    };

    document.getElementById('viewer').ontouchmove = e => {
        if (handle.style.display === 'block') {
            const x = e.touches[0].clientX;
            afterWrap.style.width = x + 'px';
            handle.style.left = x + 'px';
        }
    };
</script>
</body>
</html>
